name: Mostra Site ID da Wix (DEBUG)

on:
  workflow_dispatch: {}

jobs:
  show_sites:
    runs-on: ubuntu-latest
    steps:
      - name: Install jq
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Echo token fingerprint (verifica che il secret sia aggiornato)
        env:
          WIX_API_KEY: ${{ secrets.WIX_API_KEY }}
        run: |
          test -n "$WIX_API_KEY" || { echo "Manca il secret WIX_API_KEY"; exit 1; }
          echo -n "$WIX_API_KEY" | sha256sum | cut -c1-16 | sed 's/^/Token SHA256 (primi 16): /'

      - name: GET /sites/v1/sites
        id: call
        env:
          WIX_API_KEY: ${{ secrets.WIX_API_KEY }}
        run: |
          set -e
          code=$(curl -s -o /tmp/sites.json -w "%{http_code}" \
            -X GET "https://www.wixapis.com/sites/v1/sites" \
            -H "Authorization: $WIX_API_KEY" \
            -H "Content-Type: application/json")
          echo "HTTP $code"
          echo "---- Body (prime 2000c) ----"
          head -c 2000 /tmp/sites.json || true; echo
          echo "code=$code" >> $GITHUB_OUTPUT

      - name: Estratto utile (id | name | domain)
        if: steps.call.outputs.code == '200'
        run: |
          jq -r '.sites[]? | "\(.id) | \(.name // "") | \(.primaryDomain.url // .domain // "")"' /tmp/sites.json || true

      - name: Upload sites.json
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: wix-sites-json
          path: /tmp/sites.json
