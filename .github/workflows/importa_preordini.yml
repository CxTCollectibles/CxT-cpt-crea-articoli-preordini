name: importa_preordini

on:
  workflow_dispatch:

jobs:
  run:
    runs-on: ubuntu-latest

    env:
      CSV_PATH: input/template_preordini_v7.csv

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: Preflight API (auto-try raw/Bearer + metaSiteId/siteId)
        env:
          WIX_SITE_ID: ${{ secrets.WIX_SITE_ID }}         # metaSiteId
          WIX_SITE_ID_ALT: ${{ secrets.WIX_SITE_ID_ALT }} # siteId (opzionale)
          WIX_API_KEY: ${{ secrets.WIX_API_KEY }}
        run: |
          set -e
          test -n "$WIX_API_KEY" || (echo "WIX_API_KEY mancante" && exit 1)
          test -n "$WIX_SITE_ID" || (echo "WIX_SITE_ID mancante" && exit 1)

          try_call () {
            local AUTH_HDR="$1"
            local SITE="$2"
            local PATH="$3"
            echo ">>> Test: $AUTH_HDR | wix-site-id=$SITE | GET $PATH"
            curl -sS -D /tmp/h -o /tmp/b \
              -H "Authorization: $AUTH_HDR" \
              -H "wix-site-id: $SITE" \
              "https://www.wixapis.com$PATH" || true
            code=$(grep -i "^HTTP/" /tmp/h | tail -1 | awk '{print $2}')
            echo "HTTP $code"
            if [ "$code" = "200" ]; then
              echo "OK"
              return 0
            else
              echo "--- HEADERS ---"; cat /tmp/h
              echo "--- BODY ---"; cat /tmp/b
              return 1
            fi
          }

          ok=0
          # combinazioni da provare (raw e Bearer) × (metaSiteId e (se c'è) siteId)
          for AUTH in "$WIX_API_KEY" "Bearer $WIX_API_KEY"; do
            for SID in "$WIX_SITE_ID" ${WIX_SITE_ID_ALT:+$WIX_SITE_ID_ALT}; do
              try_call "$AUTH" "$SID" "/stores/v1/collections?limit=1" && ok=1 && break
              try_call "$AUTH" "$SID" "/stores/v1/products?limit=1"   && ok=1 && break
            done
            [ $ok -eq 1 ] && break
          done

          if [ $ok -ne 1 ]; then
            echo "Preflight fallito. Cause tipiche:"
            echo "1) API key senza permessi Wix Stores"
            echo "2) Header wix-site-id non allineato (metaSiteId vs siteId)"
            echo "3) Formato Authorization non accettato (raw/Bearer)"
            exit 2
          fi

      - name: Importa/aggiorna prodotti da CSV
        env:
          WIX_SITE_ID: ${{ secrets.WIX_SITE_ID }}
          WIX_SITE_ID_ALT: ${{ secrets.WIX_SITE_ID_ALT }}
          WIX_API_KEY: ${{ secrets.WIX_API_KEY }}
        run: |
          python3 wix_preorder_ingestion.py "$CSV_PATH"
