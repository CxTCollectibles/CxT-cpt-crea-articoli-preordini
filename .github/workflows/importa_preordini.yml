name: importa_preordini

on:
  workflow_dispatch:

jobs:
  run:
    runs-on: ubuntu-latest

    env:
      CSV_PATH: input/template_preordini_v7.csv

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: Preflight API (Python, no shell tools)
        env:
          WIX_SITE_ID: ${{ secrets.WIX_SITE_ID }}         # metaSiteId (obbligatorio)
          WIX_SITE_ID_ALT: ${{ secrets.WIX_SITE_ID_ALT }} # siteId “corto” (opzionale)
          WIX_API_KEY: ${{ secrets.WIX_API_KEY }}
        run: |
          python - <<'PY'
          import os, sys, requests

          base = "https://www.wixapis.com"
          api_key = os.environ.get("WIX_API_KEY", "").strip()
          msid    = os.environ.get("WIX_SITE_ID", "").strip()
          sid_alt = os.environ.get("WIX_SITE_ID_ALT", "").strip()

          if not api_key:
            print("WIX_API_KEY mancante"); sys.exit(1)
          if not msid:
            print("WIX_SITE_ID mancante (serve il metaSiteId)"); sys.exit(1)

          sites = [msid] + ([sid_alt] if sid_alt else [])
          auths = [api_key, f"Bearer {api_key}"]
          paths = ["/stores/v1/collections?limit=1", "/stores/v1/products?limit=1"]

          ok = False
          for auth in auths:
            for site in sites:
              for path in paths:
                try:
                  print(f">>> Test Authorization='{auth.split()[0]}' wix-site-id={site} GET {path}")
                  r = requests.get(base + path, headers={
                    "Authorization": auth,
                    "wix-site-id": site
                  }, timeout=20)
                  print("HTTP", r.status_code)
                  if r.status_code == 200:
                    ok = True
                    break
                  else:
                    print("Headers:", dict(r.headers))
                    print("Body:", r.text[:400])
                except Exception as e:
                  print("EXC:", e)
              if ok: break
            if ok: break

          if not ok:
            print("Preflight fallito. Possibili cause:")
            print("1) Permessi Stores mancanti alla API key")
            print("2) wix-site-id non allineato (metaSiteId vs siteId)")
            print("3) Formato Authorization non accettato (raw/Bearer)")
            sys.exit(2)
          PY

      - name: Importa/aggiorna prodotti da CSV
        env:
          WIX_SITE_ID: ${{ secrets.WIX_SITE_ID }}
          WIX_SITE_ID_ALT: ${{ secrets.WIX_SITE_ID_ALT }}
          WIX_API_KEY: ${{ secrets.WIX_API_KEY }}
        run: |
          python3 wix_preorder_ingestion.py "$CSV_PATH"
