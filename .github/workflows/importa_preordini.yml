name: Importa Preordini su Wix

on:
  workflow_dispatch:
    inputs:
      # Opzione A: file nel repo (consigliata)
      csv_dir:
        description: "Cartella nel repo (lascia input/)"
        required: true
        default: "input/"
      csv_name:
        description: "Nome del file CSV (es. template_preordini_v5.csv)"
        required: false
        default: ""
      # Opzione B: URL pubblico del CSV
      csv_url:
        description: "URL pubblico del CSV (alternativa a csv_dir/csv_name)"
        required: false
        default: ""
      # Opzione C: incolla il contenuto del CSV
      csv_inline:
        description: "Incolla qui il contenuto CSV (alternativa a csv_dir/csv_name)"
        required: false
        default: ""
  push:
    paths:
      - "input/*.csv"

jobs:
  import:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests beautifulsoup4 lxml

      - name: Debug repo tree
        run: |
          echo "Contenuto repo:"
          ls -la
          echo "Contenuto input/:"
          ls -la input || true

      - name: Prepare CSV
        id: prep
        shell: bash
        run: |
          set -e
          mkdir -p input

          # 1) Contenuto incollato (priorità massima)
          if [ -n "${{ github.event.inputs.csv_inline }}" ]; then
            printf "%s" "${{ github.event.inputs.csv_inline }}" > input/inline.csv
            echo "csv=input/inline.csv" >> $GITHUB_OUTPUT
            echo "source=inline" >> $GITHUB_OUTPUT
            exit 0
          fi

          # 2) URL pubblico
          if [ -n "${{ github.event.inputs.csv_url }}" ]; then
            echo "Scarico CSV da URL..."
            curl -L --fail --retry 3 --connect-timeout 15 "${{ github.event.inputs.csv_url }}" -o input/from_url.csv
            echo "csv=input/from_url.csv" >> $GITHUB_OUTPUT
            echo "source=url" >> $GITHUB_OUTPUT
            exit 0
          fi

          # 3) Percorso nel repo: csv_dir + csv_name (input/ è già preimpostato)
          dir="${{ github.event.inputs.csv_dir }}"
          name="${{ github.event.inputs.csv_name }}"
          # se l'utente ha lasciato vuoto csv_name, prova a prendere l'ultimo file nella cartella
          if [ -z "$name" ]; then
            latest=$(ls -t "$dir"/*.csv 2>/dev/null | head -n1 || true)
            if [ -z "$latest" ]; then
              echo "Nessun CSV trovato in $dir. Carica un file o usa csv_url/csv_inline." >&2
              exit 1
            fi
            echo "csv=$latest" >> $GITHUB_OUTPUT
            echo "source=latest_in_dir" >> $GITHUB_OUTPUT
            exit 0
          fi
          # aggiungi .csv se l'utente ha scritto solo il nome senza estensione
          if [[ "$name" != *.csv ]]; then
            name="${name}.csv"
          fi
          path="${dir%/}/$name"
          if [ ! -f "$path" ]; then
            echo "File non trovato: $path" >&2
            echo "Suggerimento: carica il file in $dir o usa csv_inline/csv_url." >&2
            exit 1
          fi
          echo "csv=$path" >> $GITHUB_OUTPUT
          echo "source=dir+name" >> $GITHUB_OUTPUT

      - name: Run importer
        env:
          WIX_API_KEY: ${{ secrets.WIX_API_KEY }}
          WIX_SITE_ID: ${{ secrets.WIX_SITE_ID }}
        run: |
          python wix_preorder_ingestion.py --csv "${{ steps.prep.outputs.csv }}"

      - name: Esito
        run: |
          echo "CSV usato: ${{ steps.prep.outputs.csv }} (source=${{ steps.prep.outputs.source }})"
