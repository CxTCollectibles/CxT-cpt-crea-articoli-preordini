name: Importa Preordini su Wix

on:
  workflow_dispatch:
    inputs:
      csv_path:
        description: "Percorso CSV nel repo (es. input/miofile.csv)"
        required: false
        default: ""
      csv_url:
        description: "URL pubblico del CSV (verrÃ  scaricato al volo)"
        required: false
        default: ""
      csv_inline:
        description: "Incolla qui il contenuto CSV (opzionale)"
        required: false
        default: ""
  push:
    paths:
      - "input/*.csv"

jobs:
  import:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests beautifulsoup4 lxml

      - name: Prepare CSV
        id: prep
        shell: bash
        run: |
          set -e
          mkdir -p input

          # 1) Contenuto incollato (prioritario)
          if [ -n "${{ github.event.inputs.csv_inline }}" ]; then
            printf "%s" "${{ github.event.inputs.csv_inline }}" > input/inline.csv
            echo "csv=input/inline.csv" >> $GITHUB_OUTPUT
            echo "source=inline" >> $GITHUB_OUTPUT
            exit 0
          fi

          # 2) URL pubblico
          if [ -n "${{ github.event.inputs.csv_url }}" ]; then
            echo "Scarico CSV da URL..."
            curl -L --fail --retry 3 --connect-timeout 15 "${{ github.event.inputs.csv_url }}" -o input/from_url.csv
            echo "csv=input/from_url.csv" >> $GITHUB_OUTPUT
            echo "source=url" >> $GITHUB_OUTPUT
            exit 0
          fi

          # 3) Percorso nel repo
          if [ -n "${{ github.event.inputs.csv_path }}" ]; then
            if [ ! -f "${{ github.event.inputs.csv_path }}" ]; then
              echo "File non trovato: ${{ github.event.inputs.csv_path }}" >&2
              exit 1
            fi
            echo "csv=${{ github.event.inputs.csv_path }}" >> $GITHUB_OUTPUT
            echo "source=path" >> $GITHUB_OUTPUT
            exit 0
          fi

          # 4) Fallback: ultimo CSV in input/
          latest=$(ls -t input/*.csv 2>/dev/null | head -n1 || true)
          if [ -z "$latest" ]; then
            echo "Nessun CSV fornito e nessun file in input/. Carica un CSV o usa csv_url/csv_inline." >&2
            exit 1
          fi
          echo "csv=$latest" >> $GITHUB_OUTPUT
          echo "source=latest" >> $GITHUB_OUTPUT

      - name: Run importer
        env:
          WIX_API_KEY: ${{ secrets.WIX_API_KEY }}
          WIX_SITE_ID: ${{ secrets.WIX_SITE_ID }}
        run: |
          python wix_preorder_ingestion.py --csv "${{ steps.prep.outputs.csv }}"

      - name: Esito
        run: |
          echo "CSV usato: ${{ steps.prep.outputs.csv }} (source=${{ steps.prep.outputs.source }})"
