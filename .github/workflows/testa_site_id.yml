name: Testa Site ID Wix

on:
  workflow_dispatch:
    inputs:
      site_id:
        description: "Incolla qui il Site ID da testare"
        required: true
        default: ""

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Provo POST /stores/v1/products/query con l'ID fornito
        env:
          WIX_API_KEY: ${{ secrets.WIX_API_KEY }}
          WIX_SITE_ID: ${{ github.event.inputs.site_id }}
        run: |
          set -e
          test -n "$WIX_API_KEY" || { echo "Manca WIX_API_KEY"; exit 1; }
          test -n "$WIX_SITE_ID" || { echo "Manca site_id"; exit 1; }
          echo "Test con wix-site-id=$WIX_SITE_ID"
          code=$(curl -s -o /tmp/out.json -w "%{http_code}" \
            -X POST "https://www.wixapis.com/stores/v1/products/query" \
            -H "Authorization: $WIX_API_KEY" \
            -H "Content-Type: application/json" \
            -H "wix-site-id: $WIX_SITE_ID" \
            -d '{"query":{}}')
          echo "HTTP $code"
          cat /tmp/out.json || true; echo
          if [ "$code" -ge 300 ]; then
            echo "Esito: NON valido o permessi insufficienti."
            exit 1
          else
            echo "Esito: OK, Site ID valido per questa chiave."
          fi
